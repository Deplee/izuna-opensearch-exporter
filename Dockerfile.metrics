FROM node:18-alpine AS deps

WORKDIR /app

# Копирование package.json
COPY package.json ./

# Установка только production зависимостей
RUN npm install --verbose --omit-dev --no-package-lock express@4.18.3 prom-client@15.1.0

# Production stage
FROM node:18-alpine AS production
WORKDIR /app

# Копирование только production зависимостей
COPY --from=deps /app/node_modules ./node_modules

# Копирование серверной части
COPY src/server ./src/server

CMD ["node", "src/server/metrics-server.js"]