FROM node:18-alpine AS deps

WORKDIR /app

# Установка только express и prom-client без дополнительных зависимостей
RUN npm install --no-package-lock --no-optional express@4.18.3 prom-client@15.1.0

# Production stage
FROM node:18-alpine AS production
WORKDIR /app

# Копирование только production зависимостей
COPY --from=deps /app/node_modules ./node_modules

# Копирование серверной части
COPY src/server ./src/server

CMD ["node", "src/server/metrics-server.js"]